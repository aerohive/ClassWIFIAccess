var db = require("./../app").db;
var School = require("./school");
var Device = require("./device");
var Lesson = require("./lesson");

function ClassroomSeralizer(row) {
    this.classroom = {};
    this.classroom.classroomName = row.classroomName;
    this.classroom.DeviceId = row.DeviceId;
    this.classroom.SchoolId = row.SchoolId;
}

ClassroomSeralizer.prototype.updateDB = function (classroomId, callback) {
    db.updateDB("Classroom", classroomId, this.classroom, function (err) {
        if (err) {
            callback(err);
        }
        console.log("Classroom UpdateDB");
        callback(err);
    });
};

ClassroomSeralizer.prototype.insertDB = function (callback) {
    db.insertDB("Classroom", this.classroom, function (err) {
        if (err) {
            callback(err);
        }
        callback(err);
    });
};

function Classroom() {
    this.id = "";
    this.classroomName = "";
    this.DeviceId = "";
    this.deviceHostname = "";
    this.SchoolId = "";
    this.schoolName = "";
    this.wifiEnabled = "";
}

function getDeviceHostname(DeviceId, callback) {
    var deviceHostname = "";
    if (DeviceId > 0) {
        Device.findById(DeviceId, null, function (err, device) {
            if (device) {
                deviceHostname = device.hostName;
            }
            callback(deviceHostname);
        });
    } else {
        callback(deviceHostname);
    }
}

function getSchoolName(SchoolId, callback) {
    var schoolName = "";
    if (SchoolId > 0) {
        School.findById(SchoolId, null, function (err, school) {
            if (school) {
                schoolName = school.schoolName;
            }
            callback(schoolName);
        });
    } else {
        callback(schoolName);
    }
}

function getWifiState(classroom, callback) {
    var currentDate = new Date().getTime();
    if (classroom.DeviceId > 0) {
        db.customSelect("Lesson",
            " ClassroomId = " + classroom.id +
            " AND SchoolId = " + classroom.SchoolId +
            " AND startDate < " + currentDate +
            " AND " +
            " (endDate > " + currentDate +
            " OR endDate = 0)",
            function (err, ret) {
                if (err) {
                    callback(err);
                }
                console.log(ret);
                if (ret.length > 0) {
                    callback(true);
                } else {
                    callback(false);
                }
            });
    } else {
        callback('');
    }
}

createClassroom = function (classroomFromDB, callback) {
    var classroom = new Classroom();
    if (classroomFromDB) {
        classroom.id = classroomFromDB.id;
        classroom.classroomName = classroomFromDB.classroomName;
        classroom.DeviceId = classroomFromDB.DeviceId;
        classroom.SchoolId = classroomFromDB.SchoolId;
        getDeviceHostname(classroom.DeviceId, function (deviceHostName) {
            classroom.deviceHostname = deviceHostName;
            getSchoolName(classroom.SchoolId, function (schoolName) {
                classroom.schoolName = schoolName;
                getWifiState(classroom, function (wifiState){
                    classroom.wifiEnabled = wifiState;
                    callback(classroom);
                });
            });
        });
    }
};



findOne = function (fields, options, callback) {
    db.findOne("Classroom", fields, options, function (err, classroomFromDB) {
        if (err) {
            callback(err);
        }
        createClassroom(classroomFromDB, function (classroom) {
            callback(err, classroom);
        });
    });
};

findById = function (rowId, options, callback) {
    db.findById("Classroom", rowId, options, function (err, classroomFromDB) {
        if (err) {
            return err;
        }
        createClassroom(classroomFromDB, function (classroom) {
            callback(err, classroom);
        });
    });
};

getAll = function (options, callback) {
    var rOptions = options || {"orderBy": "classroomName"};
    db.getAll("Classroom", rOptions, function (err, classroomsFromDB) {
        if (err) {
            callback(err);
        } else if (classroomsFromDB == null || classroomsFromDB.length == 0) {
            callback(null, null);
        } else {
            if (classroomsFromDB) {
                var insert = 0;
                var classrooms = [];
                for (var i = 0; i < classroomsFromDB.length; i++) {
                    createClassroom(classroomsFromDB[i], function (user) {
                        classrooms.push(user);
                        insert++;
                        if (insert == classroomsFromDB.length) {
                            callback(null, classrooms);
                        }
                    })
                }
            }
        }
    });
};

deleteByID = function (classroomId, callback) {
    db.deleteById("Classroom", classroomId, function (err, ret) {
        callback(ret, err);
    })
};

module.exports = Classroom;
module.exports.findAll = findAll;
module.exports.findOne = findOne;
module.exports.findById = findById;
module.exports.getAll = getAll;
module.exports.deleteById = deleteByID;
module.exports.ClassroomSeralizer = ClassroomSeralizer;