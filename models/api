var db = require("./../app").db;
var apiAuth = require("./../bin/ah_api/auth");
var apiConf = require("./../bin/ah_api/config");

function ApiSerializer(row){
    this.api = {};
    this.api.clientId= apiConf.clientId;
    this.api.ownerId= row.ownerId;
    this.api.vhmId= row.vhmId;
    this.api.vpcUrl = row.vpcUrl;
    this.api.accessToken= row.accessToken;
    this.api.refreshToken= row.refreshToken;
    this.api.expireAt= row.expireAt;
}

ApiSerializer.prototype.insertDB = function(callback){
    console.log(this.api);
    db.insertDB("API", this.api, function(err){
        if (err){
            callback(err);
        }
        callback(err);
    });
};


function ApiErrorSerializer(row){
    this.status = row.status;
    this.code = row.code;
    this.message = row.message;
    this.errorParams = row.errorParams;
}

function Api(){
    this.clientId="";
    this.ownerId="";
    this.vhmId="";
    this.vpcUrl="";
    this.accessToken="";
    this.refreshToken="";
    this.expireAt="";
}


Api.prototype.registerApp = function(authCode, callback){
    apiAuth.getPermanentToken(authCode, apiConf.redirectUrl, apiConf.secret, apiConf.clientId, function(res){
        callback(res);
    });
};

getClientId = function(){
    return apiConf.clientId;
};

getRedirectUrl = function(){
    return apiConf.redirectUrl;
};

getSecret = function(){
    return apiConf.secret;
};

findOne = function(fields, options, callback){
    db.findOne("API", fields, options, function(err, api){

        if (err){
            callback(err);
        }
        callback(err, api);
    });
};

findById = function(rowId, options, callback){
    db.findById("API", rowId, options, function(err, api){
        if (err){
            return err;
        }
        callback(err, api);
    });
};

getAll = function(options, callback){
    var rOptions = options || {"orderBy":"vhmId"};
    db.getAll("API", rOptions, function(err, apis){
        if (err){
            return err;
        }
        callback(err, apis);
    })
};

deleteByID = function(apiId, callback){
    db.deleteById("API", apiId, function(err, ret){
        callback(ret, err);
    })
};

module.exports = Api;
module.exports.findOne = findOne;
module.exports.findById = findById;
module.exports.getAll = getAll;
module.exports.ApiSerializer = ApiSerializer;
module.exports.ApiErrorSerializer = ApiErrorSerializer;
module.exports.getClientId = getClientId;
module.exports.getSecret = getSecret;
module.exports.getRedirectUrl = getRedirectUrl;
module.exports.deleteByID = deleteByID;